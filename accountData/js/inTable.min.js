var paidMoney,unpaidMoney,startDate="",endDate="";var grainType=1;var searchType=1;var currentPage=1;var depot=0;var pages;var name="";var searchStaffId="";var userId=DES3.decrypt(localStorage.getItem("userId"));var ownerId=DES3.decrypt(localStorage.getItem("ownerId"));$("#dateStart").datetimepicker({startView:4,minView:2,todayBtn:true,todayHighlight:true,language:"zh-CN"});$("#dateEnd").datetimepicker({startView:4,minView:2,todayBtn:true,todayHighlight:true,language:"zh-CN"}).on("change",function(){startDate=$("#dateStart").val();endDate=$("#dateEnd").val();getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}});getData();initPaging();var select2Array=[];var person=Restful.post("bsinventorystaff/list",{userId:ownerId,staffType:1,pageSize:1000});if(person){if(person.success){var personArr=person.dataList;select2Array.push({id:0,text:"请选择",phone:""});$.each(personArr,function(a,b){select2Array.push({id:b.staffId,text:b.trueName,phone:b.phone})})}else{select2Array.push({id:0,text:"无",phone:""})}}$("#salePerson").select2({data:select2Array,templateResult:formatState});function clearDate(){$("#dateStart,#dateEnd").val("");startDate=$("#dateStart").val();endDate=$("#dateEnd").val();getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}}function formatState(b){if(!b.id){return b.text}var a="";if(b.text!="请选择"){a=$('<span style="display: inline-block;height: 2rem;">姓名: '+b.text+"</br><span>手机号:"+b.phone+"</span></span>")}else{a=$('<span style="display: inline-block;">'+b.text+"</span>")}return a}$(".leftContent > div:nth-child(6)> p:nth-child(2)").addClass("left_active");$(".leftContent > div:nth-child(5)").addClass("left_active");$(".child").eq(2).css("display","block");$(document).on("mouseover","#accountRemark",function(){$(this).siblings("div").slideDown(100)});$(document).on("mouseout","#accountRemark",function(){$(this).siblings("div").css("display","none")});function deleteTd(){$(".rightContent thead > tr > td:nth-child(8)").css("display","none");$(".rightContent tbody > tr > td:nth-child(8)").css("display","none");$(".rightContent thead > tr > td:nth-child(12)").css("display","none");$(".rightContent tbody > tr > td:nth-child(12)").css("display","none")}function changePerson(){var a=$("#salePerson").find("option:selected").text();if(a!="请选择"){$(".staffName").html(a)}else{$(".staffName").html("全部")}}$("#timeChange").on("click","a",function(){if($(this).attr("id")=="excelBtn"){return}searchType=$(this).attr("data-timeType");currentPage=1;getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}$(this).removeClass("watch").addClass("watchActive");$(this).parent().siblings().find("a").removeClass("watchActive").addClass("watch")});$("#grainType").on("change",function(){grainType=$("#grainType").val();currentPage=1;getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}});$("#salePerson").on("change",function(){searchStaffId=$("#salePerson").val();currentPage=1;getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}});var depotre=Restful.post("bsinventorydepot/getDepots",{userId:userId});if(depotre){var html='<option value="0">全部</option>';for(var i=0,len=depotre.length;i<len;i++){html+=' <option value="'+depotre[i].id+'" >'+depotre[i].name+"</option>"}$(".depot").html("").append(html)}$("#depot").on("change",function(){depot=$("#depot").val();currentPage=1;getData();if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}});function initPaging(){$(".page").page({leng:pages,activeClass:"activP"});$(".page").on("click",function(a){currentPage=$(".activP").text();getData(1);if(searchType!=1){deleteTd();changePerson()}else{$(".rightContent td").css("display","table-cell")}})}function getData(a){var c={};c.grainType=grainType;c.currentPage=currentPage;c.searchType=searchType;c.ownerId=ownerId;c.userId=userId;c.depotId=$("#depot").val();c.recordType=1;c.pageSize=10;c.staffName=name;c.staffId=searchStaffId;c.startDate=startDate;c.endDate=endDate;var h=Restful.post("bsinventoryrecord/search",c);if(h.success){var d=h.dataList;for(var e=0,g=d.length;e<g;e++){if(d[e].paidMoney==""){d[e].paidMoney=0}if(searchType==1&&d[e].paidMoney!=""){d[e].paidMoney=d[e].paidMoney.split(",").join("")}if(d[e].unpaidMoney==""){d[e].unpaidMoney=d[e].money}}var b=$("#inTable-list").html();var j=Template7.compile(b);var f=j({inTable:d});$("#list").html(f);pages=Math.ceil(h.total/10);if(a==1){}else{initPaging()}}else{pages=1;initPaging();$("#list").html("");$("#list").html('<tr><td colspan="12"><div style="width: 100%;height: 400px;line-height: 400px;font-size: 30px;text-align: center;margin:0 auto;color: #c1c1c1;text-shadow: #999999;">暂无数据</div>')}}function rptDownLoad(){var c=$("<form>");c.attr("style","display:none");c.attr("target","");c.attr("method","post");c.attr("action","/accountBook/bsinventoryrecord/export");var b=$("<input>");b.attr("type","hidden");b.attr("name","grainType");b.attr("value",grainType);var a=$("<input>");a.attr("type","hidden");a.attr("name","searchType");a.attr("value",searchType);var g=$("<input>");g.attr("type","hidden");g.attr("name","userId");g.attr("value",userId);var f=$("<input>");f.attr("type","hidden");f.attr("name","recordType");f.attr("value",1);var e=$("<input>");e.attr("type","hidden");e.attr("name","startDate");e.attr("value",startDate);var d=$("<input>");d.attr("type","hidden");d.attr("name","endDate");d.attr("value",endDate);$("body").append(c);c.append(b);c.append(a);c.append(g);c.append(f);c.append(e);c.append(d);c.submit();c.remove()}$("#excelBtn").on("click",function(){if(confirm("导出表格?")){rptDownLoad()}});function toEdit(a){var b=$(a).attr("data-id");location.href="edit.html?id="+b}function showEdit(){if(searchType!=1){deleteTd()}else{$(".rightContent td").css("display","table-cell")}if(currentPage==1){$(".edit").css("display","inline-block")}}function fmoney(b,d){d=d>0&&d<=20?d:2;b=parseFloat((b+"").replace(/[^\d\.-]/g,"")).toFixed(d)+"";var a=b.split(".")[0].split("").reverse(),c=b.split(".")[1];t="";for(i=0;i<a.length;i++){t+=a[i]+((i+1)%3==0&&(i+1)!=a.length?",":"")}return t.split("").reverse().join("")+"."+c}$("#b-cencel").on("click",function(){$(".balanceModel").animate({left:"100%"},500)});$("#b-back").on("click",function(){$(".b-write").animate({left:"50%"},500);$(".b-yes").animate({left:"150%"},500)});$("#list").on("focus",".paidMoney",function(){$(this).val("")});$("#list").on("click","#delete",function(){var d=$(this).attr("data-id");var b=confirm("是否删除本条数据?");if(b){var c={};c.recordId=d;var a=Restful.post("bsinventoryrecord/deleteRecordOrdre",c);if(a.success){getData()}}});$("#list").on("click","#print",function(){var a=$(this).attr("data-id");window.open("dataPrint.html?id="+a)});var thatId,hasSettled,notSettled,money;$("#list").on("click",".balance",function(){thatId=$(this).attr("data-id");$(".balanceModel input").val("");var a=$(this).parent().parent().children("td");$(".b-staffName").html(a.eq(2).html()?a.eq(2).html():"无");money=parseFloat(a.eq(8).html().split(",").join(""));$(".b-money").html(money);hasSettled=parseFloat(a.eq(9).html().split(",").join(""));$(".b-hasSettled").html(hasSettled);notSettled=parseFloat(a.eq(10).html().split(",").join(""));$(".b-notSettled").html(notSettled);$(".balanceModel").animate({left:"0"},500);$(".b-yes").animate({left:"150%"},500)});var testNum=true;$("#pay").keyup(function(){if($("#pay").val()==""){$("#pay").val("")}else{var a=parseFloat($("#pay").val());$(".b-hasSettled").html(a);$(".b-notSettled").html((money-a).toFixed(2))}});$("#b-cencel").on("click",function(){$(".balanceModel").animate({left:"100%"},500)});$("#b-confirm").on("click",function(){if($("#pay").val()==""){alert("请填写付款金额")}else{if($("#pay").val()>money){alert("付款金额大于总金额");testNum=false}else{testNum=true}if(testNum){$(".b-write").animate({left:"-50%"},500);$(".b-yes").animate({left:"50%"},500)}}});$("#b-back").on("click",function(){$(".b-write").animate({left:"50%"},500);$(".b-yes").animate({left:"150%"},500)});$("#b-submit").on("click",function(){var b={};b.id=thatId;b.paidMoney=$(".b-hasSettled").html();b.unpaidMoney=$(".b-notSettled").html();if(testNum){var a=Restful.post("bsinventoryrecord/updatePaidMoney",b);if(a&&a.success){$(".balanceModel").animate({left:"100%"},500);$(".b-write").animate({left:"50%"},500);alert("结算成功");getData(1)}else{alert("结算不成功");$(".balanceModel").animate({left:"100%"},500)}}});$("#list").on("click",".delete",function(){var d=$(this).attr("data-id");var b=confirm("是否删除本条数据?");if(b){var c={};c.recordId=d;var a=Restful.post("bsinventoryrecord/deleteRecordOrdre",c);Restful.operateRecord(d,1,13);if(a.success){getData();if(searchType!=1){deleteTd()}else{$(".rightContent td").css("display","table-cell")}}}});