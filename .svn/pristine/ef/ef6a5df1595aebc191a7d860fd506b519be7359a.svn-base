$(".leftContent > div:nth-child(4)> p:nth-child(12)").addClass("left_active");$(".leftContent > div:nth-child(3)").addClass("left_active");function getQueryString(a){var c=new RegExp("(^|&)"+a+"=([^&]*)(&|$)","i");var d=window.location.search.substr(1).match(c);var b="";if(d!=null){b=d[2]}c=null;d=null;return b==null||b==""||b=="undefined"?"":b}var userId=DES3.decrypt(localStorage.getItem("userId"));var ownerId=DES3.decrypt(localStorage.getItem("ownerId"));var person=Restful.post("bsinventorystaff/list",{userId:ownerId,staffType:1,pageSize:1000});if(navigator.userAgent.indexOf("Firefox")>=0){$("input[type=number]").on("DOMMouseScroll",function(){return false})}else{$("input[type=number]").on("mousewheel",function(){return false})}var isNewPerson,driverstate,locationNum,locationText;var id=getQueryString("id");var datas=Restful.get("bsInventoryStorageTemp/"+id);$("#deduction").on("focus",function(){if($("#deduction").val()==0||$("#deduction").val()==""){$("#deduction").val("")}});var test;var depotre=Restful.post("bsinventorydepot/getDepots",{userId:userId});var depotNum=depotre.length;var mwidth=depotNum*400;$(".depot-slider").width(mwidth+"px");if(depotNum==1){$(".num1").show().siblings().html("").hide();$(".num1").html("").append('<div depotre-id="'+depotre[0].id+'" style="width:50%;height:2rem;line-height:2rem;text-align:center;color:#fff;background-color:#f7941d;margin: 0 auto;">'+depotre[0].name+"</div>")}else{if(depotNum==2){$(".num2").show().siblings().html("").hide();$(".num2 .depot-slider").html("").append('<div class="depot-active" depotre-id="'+depotre[0].id+'">'+depotre[0].name+'</div><div class="depot" depotre-id="'+depotre[1].id+'">'+depotre[1].name+"</div>")}else{$(".num3").show().siblings().html("").hide();var html="";for(var i=0,len=depotre.length;i<len;i++){html+='<div class="depot" depotre-id="'+depotre[i].id+'">'+depotre[i].name+"</div>"}$(".depot-slider").html("").append(html);$(".depot-slider div:first-child").addClass("depot-active");$(".next").on("click",function(){var a=parseInt($(".depot-slider").css("left"))*"-1";var b=a+800;if(b>=mwidth){alert("已经是最后一个库");$(".next").css("background","#ddd")}else{a=a+800;$(".depot-slider").css("left","-"+a+"px");$(".pre").css("background","#aaa")}});$(".pre").on("click",function(){var a=parseInt($(".depot-slider").css("left"))*"-1";if(a==0){alert("已经是第一个库");$(".pre").css("background","#ddd")}else{a=a-800;$(".depot-slider").css("left","-"+a+"px");$(".next").css("background","#aaa")}})}}$(".depot-slider div").each(function(a,c){if($(c).attr("depotre-id")==datas.depotId){var b;(a==0||a==1)?b=0:((a==2||a==3)?b=1:b=2);$(c).removeClass("depot-active");$(c).siblings().addClass("depot").removeClass("depot-active");$(c).addClass("depot-active");test=$(c).attr("depotre-id");$(".depot-slider").css("left",b*(-800))}});$(".depot-slider").on("click",".depot",function(){$(this).removeClass("depot-active");$(this).siblings().addClass("depot").removeClass("depot-active");$(this).addClass("depot-active");test=$(this).attr("depotre-id")});var select2Array=[],driverArray=[],licensePlate=["无"],phoneArray=[""],driverPhone=[""];if(person){if(person.success){var personArr=person.dataList;select2Array.push({id:0,text:"请选择",phone:""});$.each(personArr,function(a,b){select2Array.push({id:b.staffId,text:b.trueName,phone:b.phone});phoneArray.push(b.phone)})}else{select2Array.push({id:0,text:"无",phone:""})}}$("#buyPerson").select2({data:select2Array,templateResult:formatState});var driver=Restful.post("bsinventorystaff/list",{userId:ownerId,staffType:3,pageSize:1000});if(driver){if(driver.success){var driverArr=driver.dataList;driverArray.push({id:0,text:"请选择",phone:""});$.each(driverArr,function(a,b){driverArray.push({id:b.staffId,text:b.trueName,phone:b.phone});licensePlate.push(b.licensePlate);driverPhone.push(b.phone)})}else{driverArray.push({id:0,text:"无",phone:""})}}$("#driver").select2({data:driverArray,templateResult:formatState});$("#driver").on("change",function(){var a=$("#driver").children("option:selected").index();$("#licensePlate").val(licensePlate[a])});function formatState(b){if(!b.id){return b.text}var a="";if(b.text!="请选择"){a=$('<span style="display: inline-block;height: 2rem;">姓名: '+b.text+"</br><span>手机号:"+b.phone+"</span></span>")}else{a=$('<span style="display: inline-block;">'+b.text+"</span>")}return a}$("#date").val(datas.date);$("#buyPerson").val(datas.staffId).select2({data:select2Array,templateResult:formatState});$("#driver").val(datas.driverId).select2({data:driverArray,templateResult:formatState});$("#recordNumber").text("No."+datas.recordNumber);$("#licensePlate").val(datas.licensePlate);$("#deduction").val(datas.deduction?datas.deduction:0);$("#varietyType").val(datas.varietyType);$("#packingType").val(datas.packingType);$("#productionNiafe").val(datas.productionNiafe);$("#smell").val(datas.smell);if(datas.location){$(".addressSelete").citys({required:false,nodata:"disabled",code:datas.location,onChange:function(a){console.log(a);locationText=a.province+a.city+a.area;locationNum=a.code}})}else{$(".addressSelete").citys({required:false,nodata:"disabled",onChange:function(a){console.log(a);locationText=a.province+a.city+a.area;locationNum=a.code}})}$("#rongzhong").val(datas.bulkDensity);$("#buwanshanli").val(datas.imperfectGrains);$("#water").val(datas.moistureContent);$("#impurity").val(datas.impurity);$("#quality").val(datas.productQuality);$("#remark").val(datas.remark);$("#grossWeightIn").val(datas.grossWeightIn);$("#tareWeightIn").val(datas.tareWeightIn);$("#netWeightIn").val(datas.netWeightIn);function Calculation(){var a=$("#grossWeightIn").val();var b=$("#tareWeightIn").val();var c=$("#deduction").val();var d=a-b-c;d=d.toFixed(2);$("#netWeightIn").val(d)}$("#grossWeightIn").keyup(function(){Calculation()});$("#tareWeightIn").keyup(function(){Calculation()});$("#deduction").keyup(function(){Calculation()});var nowDate="";function checkForm(){var b=/^[1-9]\d*\.\d{0,2}|[1-9]\d*|0\.\d{0,2}|0$/;var d=/^[1-9]\d*\.\d{1}|[1-9]\d*|0\.\d{1}$/;var a=$("#grossWeightIn").val();var c=$("#tareWeightIn").val();var e=a-c;if(e<0){alert("皮重不能大于毛重");return false}if($("#addPerson").val()!=""&&$("#phone").val()==""){alert("请填写送粮人手机号");return false}if($("#phone").val()!=""&&$("#addPerson").val()==""){alert("请填写送粮人姓名");return false}if($("#addDriver").val()!=""&&$("#driverPhone").val()==""){alert("请填写司机手机号");return false}if($("#driverPhone").val()!=""&&$("#addDriver").val()==""){alert("请填写司机姓名");return false}if($("#grossWeightIn").val()==""||$("#grossWeightIn").val()<=0){$("#grossWeightIn").siblings("p").html("请填写毛重后提交");return false}else{$("#grossWeightIn").siblings("p").html("")}if($("#tareWeightIn").val()==""||$("#tareWeightIn").val()<0){$("#tareWeightIn").siblings("p").html("请填写皮重后提交");return false}else{$("#tareWeightIn").siblings("p").html("")}if(!b.test($("#grossWeightIn").val())){$("#grossWeightIn").siblings("p").html("毛重最多八位整数俩位小数");return false}else{$("#grossWeightIn").siblings("p").html("")}if(!b.test($("#tareWeightIn").val())){$("#tareWeightIn").siblings("p").html("皮重最多八位整数俩位小数");return false}else{$("#tareWeightIn").siblings("p").html("")}if($("#water").val()!=""&&!d.test($("#water").val())){$("#water").siblings("p").html("水分最多俩位整数一位小数");return false}else{$("#water").siblings("p").html("")}if($("#buwanshanli").val()!=""&&!d.test($("#buwanshanli").val())){$("#buwanshanli").siblings("p").html("不完善粒最多俩位整数一位小数");return false}else{$("#buwanshanli").siblings("p").html("")}if($("#impurity").val()!=""&&!d.test($("#impurity").val())){$("#impurity").siblings("p").html("杂质最多俩位整数一位小数");return false}else{$("#impurity").siblings("p").html("")}return true}$("#submit").on("click",function(){if(!checkForm()){return false}if($("#submit").hasClass("disable")){return;alert("不可重复提交")}$("#submit").addClass("disable");var b=$("#date").val();var c={};var j=locationNum;var g=locationText;c.id=datas.id;c.recordType=3;c.userId=ownerId;c.operateUserId=userId;c.depotId=test;c.recordNumber=$("#recordNumber").text().replace("No.","");c.date=b;c.licensePlate=$("#licensePlate").val();c.bulkDensity=$("#rongzhong").val();c.imperfectGrains=$("#buwanshanli").val();c.moistureContent=$("#water").val();c.impurity=$("#impurity").val();c.productQuality=$("#quality").val();c.remark=$("#remark").val();c.smell=$("#smell").val();if(c.productQuality!=null&&c.productQuality!=""&&c.productQuality*1>0){if(c.bulkDensity==null||c.bulkDensity==""){alert("请填写容重！");$("#submit").removeClass("disable");return false}if(c.productQuality*1==1){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<790){alert("质量与容重不匹配，容重必须大于等于 790！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==2){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<770||c.bulkDensity*1>790){alert("质量与容重不匹配，容重必须大于等于 770，小于790！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==3){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<750||c.bulkDensity*1>770){alert("质量与容重不匹配，容重必须大于等于 750，小于770！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==4){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<730||c.bulkDensity*1>750){alert("质量与容重不匹配，容重必须大于等于 730，小于750！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==5){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<710||c.bulkDensity*1>730){alert("质量与容重不匹配，容重必须大于等于 710，小于730！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==6){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1>710){alert("质量与容重不匹配，容重必须小于 710！");$("#submit").removeClass("disable");return false}}}}}}}}c.grainType=1;if(j==undefined){j=""}if(g==undefined){g=""}c.location=j;c.locationDesc=g;c.deduction=$("#deduction").val();c.varietyType=$("#varietyType").val();c.packingType=$("#packingType").val();c.productionNiafe=$("#productionNiafe").val();c.grossWeightIn=$("#grossWeightIn").val();c.tareWeightIn=$("#tareWeightIn").val();c.netWeightIn=$("#netWeightIn").val();var f=false;if(driverstate){c.driverId=-100;c.driverName=$("#addDriver").val();c.driverPhone=$("#driverPhone").val();if(c.driverPhone!=null&&c.driverPhone!=""){var a={};a.userId=ownerId;a.staffType=3;a.phone=$("#driverPhone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var e=$("#driver").val();if(e!=0){c.driverId=e;c.driverName=$("#driver").find("option:selected").text();var k=$("#driver").children("option:selected").index();c.driverPhone=driverPhone[k]}else{c.driverId="";c.driverName="";c.driverPhone=""}}if(!f){}else{alert("司机手机号已存在");$("#submit").removeClass("disable");return}if(isNewPerson){c.staffId=-100;c.staffName=$("#addPerson").val();c.staffPhone=$("#phone").val();if(c.staffPhone!=null&&c.staffPhone!=""){var a={};a.userId=ownerId;a.staffType=staffType;a.phone=$("#phone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var d=$("#buyPerson").val();if(d!=0){c.staffId=d;c.staffName=$("#buyPerson").find("option:selected").text();var k=$("#buyPerson").children("option:selected").index();c.staffPhone=phoneArray[k]}else{c.staffId="";c.staffName="";c.staffPhone=""}}if((c.driverName==""||c.driverName==null)&&(c.staffName==""||c.staffName==null)){alert("司机和送粮人至少填一项！");$("#submit").removeClass("disable");return false}console.log(c);if(!f){var h=Restful.post("bsinventorystorage/insert",c);if(h.success){alert("保存成功");window.location.href="storageTable.html"}else{alert("提交失败，稍后再试");$("#submit").removeClass("disable")}}else{alert("送粮人手机号已存在");$("#submit").removeClass("disable")}});$(document).on("click","#change-add",function(){isNewPerson=true;$("#addPerson").val("");$("#buyPerson").parent("label").css("display","none");$("#change-add").css("display","none");$("#addPerson").css("display","inline-block");$("#phone").css("display","inline-block");$("#change-sel").css("display","inline-block")});$(document).on("click","#change-sel",function(){isNewPerson=false;$("#buyPerson").css("width","60%").parent("label").css("display","");$("#change-add").css("display","inline-block");$("#addPerson").css("display","none");$("#phone").css("display","none");$("#change-sel").css("display","none")});$(document).on("click","#driver-add",function(){driverstate=true;$("#addDriver").val("");$("#driver").parent("label").css("display","none");$("#driver-add").css("display","none");$("#addDriver").css("display","inline-block");$("#driverPhone").css("display","inline-block");$("#driver-sel").css("display","inline-block")});$(document).on("click","#driver-sel",function(){driverstate=false;$("#driver").css("width","60%").parent("label").css("display","");$("#driver-add").css("display","inline-block");$("#addDriver").css("display","none");$("#driverPhone").css("display","none");$("#driver-sel").css("display","none")});function numberCtrl(b,c){var d=$(b).val();var e=d.split(".");if(e.length>1){if(e[1].length>c){e[1]=e[1].substring(0,c)}$(b).val(e[0]+"."+e[1])}};