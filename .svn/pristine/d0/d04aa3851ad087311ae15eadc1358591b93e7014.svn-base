var isNewPerson=false;var driverstate=false;var userId=DES3.decrypt(localStorage.getItem("ud"));var ownerId=DES3.decrypt(localStorage.getItem("ownerId"));var locationText,locationNum;$(".addressSelete").citys({required:false,nodata:"disabled",onChange:function(a){console.log(a);locationText=a.province+a.city+a.area;locationNum=a.code}});var depotRes=Restful.post("bsinventorydepot/getDepots",{userId:userId});if(depotRes){var html="";for(var i=0,len=depotRes.length;i<len;i++){html+='<li data-depot="'+depotRes[i].id+'">'+depotRes[i].name+"</li>"}$(".select").html("").append(html);$(".nav h2").html($(".select li").eq(0).text()+'—出库单 <img src="accountData/img/u40.png"/>');$(".select li").eq(0).addClass("depotChange")}else{$(".select").html("").append('<li data-depot="0">默认库</li>');$(".nav h2").html($(".select li").eq(0).text()+'—出库单 <img src="accountData/img/u40.png"/>');$(".select li").eq(0).addClass("depotChange")}$(".nav").click(function(){$(".select").slideToggle()});$(".select").on("click","li",function(){var a=$(this).text();$(this).addClass("depotChange").siblings().removeClass("depotChange");$(".nav h2").html(a+'—出库单 <img src="accountData/img/u40.png"/>')});$("#deduction").on("focus",function(){if($("#deduction").val()==0||$("#deduction").val()==""){$("#deduction").val("")}});var select2Array=[],driverArray=[],licensePlate=["无"],phoneArray=[""],driverPhone=[""];var person=Restful.post("bsinventorystaff/list",{userId:ownerId,staffType:2,pageSize:1000});if(person){if(person.success){var personArr=person.dataList;select2Array.push({id:0,text:"请选择",phone:""});$.each(personArr,function(a,b){select2Array.push({id:b.staffId,text:b.trueName,phone:b.phone});phoneArray.push(b.phone)})}else{select2Array.push({id:0,text:"无",phone:""})}}var driver=Restful.post("bsinventorystaff/list",{userId:ownerId,staffType:3,pageSize:1000});if(driver){if(driver.success){var driverArr=driver.dataList;driverArray.push({id:0,text:"请选择",phone:""});$.each(driverArr,function(a,b){driverArray.push({id:b.staffId,text:b.trueName,phone:b.phone});licensePlate.push(b.licensePlate);driverPhone.push(b.phone)})}else{driverArray.push({id:0,text:"无",phone:""})}}$("#salePerson").select2({data:select2Array,templateResult:formatState});$("#driver").select2({data:driverArray,templateResult:formatState});$("#driver").on("change",function(){var a=$("#driver").children("option:selected").index()});function formatState(b){if(!b.id){return b.text}var a="";if(b.text!="请选择"){a=$('<span style="display: inline-block;height: 2rem;">姓名: '+b.text+"</br><span>手机号:"+b.phone+"</span></span>")}else{a=$('<span style="display: inline-block;">'+b.text+"</span>")}return a}$(function(){for(var d=0;d<24;d++){var a=d;if(a<10){a="0"+d}$("#hour").append('<option value="'+a+'">'+a+"</option>")}for(var d=0;d<60;d++){var a=d;if(a<10){a="0"+d}$("#minute").append('<option value="'+a+'">'+a+"</option>")}var f=new Date();var e=f.getFullYear();var g=f.getMonth()+1;if(g<10){g="0"+g}var c=f.getDate();if(c<10){c="0"+c}var b=f.getHours();if(b<10){b="0"+b}var h=f.getMinutes();if(h<10){h="0"+h}nowDate=e+"-"+g+"-"+c;$("#date").val(nowDate);$("#hour").val(b);$("#minute").val(h)});function Calculation(){var b=$("#grossWeightOut").val();var a=$("#tareWeightOut").val();var d=$("#unitPrice").val();var e=$("#deduction").val();var c=b-a-e;c=c.toFixed(2);var f=c*d*2;f=f.toFixed(2);$("#netWeightOut").val(c);$("#moneyOut").val(f)}$("#grossWeightOut").on("input",function(){Calculation()});$("#tareWeightOut").on("input",function(){Calculation()});$("#unitPrice").on("input",function(){Calculation()});$("#deduction").on("input",function(){Calculation()});$(document).on("change","#grainType",function(){var a=$("#grainType").val();if(a==1){$(".xmlist").show();$(".meibian").hide()}else{$(".xmlist").hide();$(".meibian").show()}});$(document).on("click","#submit",function(){var f=false;if(!checkForm()){return false}if($("#submit").hasClass("disable")){alert("不可重复提交");return}$("#submit").addClass("disable");var b=$("#date").val();var c={};var k=locationNum;var h=locationText;c.recordType=2;c.userId=ownerId;c.operateUserId=userId;c.depotId=$(".depotChange").attr("data-depot");c.date=b;c.licensePlate=$("#licensePlate").val();c.bulkDensity=$("#rongzhong").val();c.imperfectGrains=$("#buwanshanli").val();c.moistureContent=$("#water").val();c.impurity=$("#impurity").val();c.mildew=$("#meibian").val();c.productQuality=$("#quality").val();c.remark=$("#remark").val();c.grainType=$("#grainType").val();c.grossWeightOut=$("#grossWeightOut").val();c.netWeightOut=$("#netWeightOut").val();c.tareWeightOut=$("#tareWeightOut").val();c.unitPrice=$("#unitPrice").val();c.moneyOut=$("#moneyOut").val();c.deduction=$("#deduction").val();c.varietyType=$("#varietyType").val();c.packingType=$("#packingType").val();c.productionNiafe=$("#productionNiafe").val();if(c.grainType==1){if(c.productQuality!=null&&c.productQuality!=""&&c.productQuality*1>0){if(c.bulkDensity==null||c.bulkDensity==""){alert("请填写容重！");$("#submit").removeClass("disable");return false}if(c.productQuality*1==1){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<790){alert("质量与容重不匹配，容重必须大于等于 790！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==2){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<770||c.bulkDensity*1>790){alert("质量与容重不匹配，容重必须大于等于 770，小于790！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==3){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<750||c.bulkDensity*1>770){alert("质量与容重不匹配，容重必须大于等于 750，小于770！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==4){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<730||c.bulkDensity*1>750){alert("质量与容重不匹配，容重必须大于等于 730，小于750！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==5){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<710||c.bulkDensity*1>730){alert("质量与容重不匹配，容重必须大于等于 710，小于730！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==6){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1>710){alert("质量与容重不匹配，容重必须小于 710！");$("#submit").removeClass("disable");return false}}}}}}}}}else{if(c.grainType!=3){if(c.productQuality!=null&&c.productQuality!=""&&c.productQuality*1>0){if(c.bulkDensity==null||c.bulkDensity==""){alert("请填写容重！");$("#submit").removeClass("disable");return false}if(c.productQuality*1==1){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<720){alert("质量与容重不匹配，容重必须大于等于 720！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==2){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<685||c.bulkDensity*1>720){alert("质量与容重不匹配，容重必须大于等于 685，小于720！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==3){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<650||c.bulkDensity*1>685){alert("质量与容重不匹配，容重必须大于等于 650，小于685！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==4){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<620||c.bulkDensity*1>650){alert("质量与容重不匹配，容重必须大于等于 620，小于650！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==5){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<590||c.bulkDensity*1>620){alert("质量与容重不匹配，容重必须大于等于 590，小于620！");$("#submit").removeClass("disable");return false}}else{if(c.productQuality*1==6){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1>590){alert("质量与容重不匹配，容重必须小于 590！");$("#submit").removeClass("disable");return false}}}}}}}}}}c.smell=$("#smell").val();if(k==undefined){k=""}if(h==undefined){h=""}c.location=k;c.locationDesc=h;if(driverstate){c.driverId=-100;c.driverName=$("#addDriver").val();c.driverPhone=$("#driverPhone").val();if(c.driverPhone!=null&&c.driverPhone!=""){var a={};a.userId=ownerId;a.staffType=3;a.phone=$("#driverPhone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var e=$("#driver").val();if(e!=0){c.driverId=e;c.driverName=$("#driver").find("option:selected").text();var l=$("#driver").children("option:selected").index();c.driverPhone=driverPhone[l]}else{c.driverId="";c.driverName="";c.driverPhone=""}}if(!f){}else{alert("司机手机号已存在");$("#submit").removeClass("disable");return}if(isNewPerson){c.staffId=-100;c.staffName=$("#addPerson").val();c.staffPhone=$("#phone").val();if(c.staffPhone!=null&&c.staffPhone!=""){var a={};a.userId=ownerId;a.staffType=2;a.phone=$("#phone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var d=$("#salePerson").val();if(d!=0){c.staffId=$("#salePerson").val();c.staffName=$("#salePerson option:selected").text();var l=$("#salePerson").children("option:selected").index();c.staffPhone=phoneArray[l]}else{c.staffId="";c.staffName="";c.staffPhone=""}}console.log(c);if(!f){var g;$.each(depotRes,function(m,n){if(depotRes[m].id==$(".depotChange").attr("data-depot")){g=depotRes[m].name}});if(window.confirm("确定要保存到"+g+"库吗？")){var j=Restful.post("bsinventoryrecord/insert",c);if(j.success){alert("保存成功");Restful.operateRecord(j.retcode,2,21);if(recordType==1){window.location.href="inStorage.html"}else{if(recordType==2){window.location.href="outStorage.html"}}}else{$("#submit").removeClass("disable");alert("提交失败，稍后再试")}}else{$("#submit").removeClass("disable")}}else{alert("送粮人手机号已存在");$("#submit").removeClass("disable")}});$(document).on("click","#temporary",function(){var f=false;if(!checkForms()){return false}if($("#temporary").hasClass("disable")){alert("不可重复提交");return}$("#temporary").addClass("disable");var b=$("#date").val();var c={};var j=locationNum;var g=locationText;c.recordType=2;c.userId=ownerId;c.operateUserId=userId;c.depotId=$(".depotChange").attr("data-depot");c.date=b;c.licensePlate=$("#licensePlate").val();c.bulkDensity=$("#rongzhong").val();c.imperfectGrains=$("#buwanshanli").val();c.moistureContent=$("#water").val();c.impurity=$("#impurity").val();c.mildew=$("#meibian").val();c.productQuality=$("#quality").val();c.remark=$("#remark").val();c.grainType=$("#grainType").val();c.grossWeightOut=$("#grossWeightOut").val();c.netWeightOut=$("#netWeightOut").val();c.tareWeightOut=$("#tareWeightOut").val();c.unitPrice=$("#unitPrice").val();c.moneyOut=$("#moneyOut").val();c.deduction=$("#deduction").val();c.varietyType=$("#varietyType").val();c.packingType=$("#packingType").val();c.productionNiafe=$("#productionNiafe").val();c.smell=$("#smell").val();if(c.grainType==1){if(c.productQuality!=null&&c.productQuality!=""&&c.productQuality*1>0){if(c.bulkDensity==null||c.bulkDensity==""){alert("请填写容重！");$("#temporary").removeClass("disable");return false}if(c.productQuality*1==1){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<790){alert("质量与容重不匹配，容重必须大于等于 790！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==2){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<770||c.bulkDensity*1>790){alert("质量与容重不匹配，容重必须大于等于 770，小于790！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==3){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<750||c.bulkDensity*1>770){alert("质量与容重不匹配，容重必须大于等于 750，小于770！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==4){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<730||c.bulkDensity*1>750){alert("质量与容重不匹配，容重必须大于等于 730，小于750！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==5){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<710||c.bulkDensity*1>730){alert("质量与容重不匹配，容重必须大于等于 710，小于730！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==6){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1>710){alert("质量与容重不匹配，容重必须小于 710！");$("#temporary").removeClass("disable");return false}}}}}}}}}else{if(c.grainType!=3){if(c.productQuality!=null&&c.productQuality!=""&&c.productQuality*1>0){if(c.bulkDensity==null||c.bulkDensity==""){alert("请填写容重！");$("#temporary").removeClass("disable");return false}if(c.productQuality*1==1){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<720){alert("质量与容重不匹配，容重必须大于等于 720！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==2){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<685||c.bulkDensity*1>720){alert("质量与容重不匹配，容重必须大于等于 685，小于720！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==3){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<650||c.bulkDensity*1>685){alert("质量与容重不匹配，容重必须大于等于 650，小于685！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==4){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<620||c.bulkDensity*1>650){alert("质量与容重不匹配，容重必须大于等于 620，小于650！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==5){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1<590||c.bulkDensity*1>620){alert("质量与容重不匹配，容重必须大于等于 590，小于620！");$("#temporary").removeClass("disable");return false}}else{if(c.productQuality*1==6){if(c.bulkDensity!=null&&c.bulkDensity!=""&&c.bulkDensity*1>590){alert("质量与容重不匹配，容重必须小于 590！");$("#temporary").removeClass("disable");return false}}}}}}}}}}if(j==undefined){j=""}if(g==undefined){g=""}c.location=j;c.locationDesc=g;if(driverstate){c.driverId=-100;c.driverName=$("#addDriver").val();c.driverPhone=$("#driverPhone").val();if(c.driverPhone!=null&&c.driverPhone!=""){var a={};a.userId=ownerId;a.staffType=3;a.phone=$("#driverPhone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var e=$("#driver").val();if(e!=0){c.driverId=e;c.driverName=$("#driver").find("option:selected").text();var k=$("#driver").children("option:selected").index();c.driverPhone=driverPhone[k]}else{c.driverId="";c.driverName="";c.driverPhone=""}}if(c.driverName==""||c.driverName==null){alert("司机不能为空！");$("#temporary").removeClass("disable");return false}if(!f){}else{alert("司机手机号已存在");$("#temporary").removeClass("disable");return}if(isNewPerson){c.staffId=-100;c.staffName=$("#addPerson").val();c.staffPhone=$("#phone").val();if(c.staffPhone!=null&&c.staffPhone!=""){var a={};a.userId=ownerId;a.staffType=2;a.phone=$("#phone").val();f=Restful.post("bsinventorystaff/isExist",a)}}else{var d=$("#salePerson").val();if(d!=0){c.staffId=$("#salePerson").val();c.staffName=$("#salePerson option:selected").text();var k=$("#salePerson").children("option:selected").index();c.staffPhone=phoneArray[k]}else{c.staffId="";c.staffName=""}}console.log(c);if(!f){var h=Restful.post("bsInventoryTemporary/insert",c);if(h.success){alert("暂存成功");window.location.href="noOutFormMobile.html"}else{alert("提交失败，稍后再试");$("#temporary").removeClass("disable")}}else{alert("买粮人手机号已存在");$("#temporary").removeClass("disable")}});function checkForms(){var j=/^[1-9]\d*\.\d{0,2}|[1-9]\d*|0\.\d{0,2}|0$/;var k=/^[1-9]\d*\.\d{1}|[1-9]\d*|0\.\d{1}$/;var a=/^[1-9]\d*\.\d{0,3}|[1-9]\d*|0\.\d{0,3}$/;var g=$("#grainType").val();var c=$("#date").val();var f=$("#hour").val();var e=$("#minute").val();var b=f+":"+e;var d=$("#grossWeightOut").val();var l=$("#tareWeightOut").val();var h=$("#unitPrice").val();if($("#grossWeightOut").val()==""&&$("#tareWeightOut").val()==""){alert("毛重和皮重两项必填一项！");return false}if($("#grossWeightOut").val()!=null&&$("#grossWeightOut").val()!=""&&!j.test($("#grossWeightOut").val())){$("#grossWeightOut").siblings("p").html("毛重最多八位整数俩位小数");return false}else{$("#grossWeightOut").siblings("p").html("")}if($("#tareWeightOut").val()!=null&&$("#tareWeightOut").val()!=""&&!j.test($("#tareWeightOut").val())){$("#tareWeightOut").siblings("p").html("皮重最多八位整数俩位小数");return false}else{$("#tareWeightOut").siblings("p").html("")}if($("#addPerson").val()!=""&&$("#phone").val()==""){alert("请填写买粮人手机号");return false}if($("#phone").val()!=""&&$("#addPerson").val()==""){alert("请填写买粮人姓名");return false}if($("#addDriver").val()!=""&&$("#driverPhone").val()==""){alert("请填写司机手机号");return false}if($("#driverPhone").val()!=""&&$("#addDriver").val()==""){alert("请填写司机姓名");return false}if($("#unitPrice").val()!=""&&!a.test($("#unitPrice").val())){}if($("#water").val()!=""&&!k.test($("#water").val())){alert("水分最多俩位整数一位小数");return false}if($("#meibian").val()!=""&&!k.test($("#meibian").val())){alert("霉变最多俩位整数一位小数");return false}if($("#buwanshanli").val()!=""&&!k.test($("#buwanshanli").val())){alert("不完善粒最多俩位整数一位小数");return false}if($("#impurity").val()!=""&&!k.test($("#impurity").val())){alert("杂质最多俩位整数一位小数");return false}return true}function checkForm(){var j=/^[1-9]\d*\.\d{0,2}|[1-9]\d*|0\.\d{0,2}|0$/;var k=/^[1-9]\d*\.\d{1}|[1-9]\d*|0\.\d{1}$/;var a=/^[1-9]\d*\.\d{0,3}|[1-9]\d*|0\.\d{0,3}$/;var g=$("#grainType").val();var c=$("#date").val();var f=$("#hour").val();var e=$("#minute").val();var b=f+":"+e;var d=$("#grossWeightOut").val();var m=$("#tareWeightOut").val();var h=$("#unitPrice").val();var l=d-m;if(l<0){alert("皮重不能大于毛重");return false}if($("#addPerson").val()!=""&&$("#phone").val()==""){alert("请填写买粮人手机号");return false}if($("#phone").val()!=""&&$("#addPerson").val()==""){alert("请填写买粮人姓名");return false}if($("#addDriver").val()!=""&&$("#driverPhone").val()==""){alert("请填写司机手机号");return false}if($("#driverPhone").val()!=""&&$("#addDriver").val()==""){alert("请填写司机姓名");return false}if($("#grossWeightOut").val()==""||$("#grossWeightOut").val()<=0){alert("请填写毛重后提交");return false}if($("#tareWeightOut").val()==""||$("#tareWeightOut").val()<0){alert("请填写皮重后提交");return false}if($("#unitPrice").val()==""){alert("请填写单价后提交");return false}if(!j.test($("#grossWeightOut").val())){alert("毛重最多八位整数俩位小数");return false}if(!j.test($("#tareWeightOut").val())){alert("皮重最多八位整数俩位小数");return false}if(!a.test($("#unitPrice").val())){alert("单价最多三位整数俩位小数");return false}if($("#water").val()!=""&&!k.test($("#water").val())){alert("水分最多俩位整数一位小数");return false}if($("#meibian").val()!=""&&!k.test($("#meibian").val())){alert("霉变最多俩位整数一位小数");return false}if($("#buwanshanli").val()!=""&&!k.test($("#buwanshanli").val())){alert("不完善粒最多俩位整数一位小数");return false}if($("#impurity").val()!=""&&!k.test($("#impurity").val())){alert("杂质最多俩位整数一位小数");return false}return true}$(document).on("click","#change-add",function(){isNewPerson=true;$("#addPerson").val("");$("#salePerson").parent("label").css("display","none");$("#change-add").css("display","none");$(".heiChange").css("height","4rem");$("#addPerson").css("display","block");$("#phone").css("display","block");$("#change-sel").css("display","inline-block")});$(document).on("click","#change-sel",function(){isNewPerson=false;$("#salePerson").css("width","80%").parent("label").css("display","inline-block");$("#change-add").css("display","block");$("#addPerson").css("display","none");$(".heiChange").css("height","2rem");$("#phone").css("display","none");$("#change-sel").css("display","none")});$(document).on("click","#driver-add",function(){driverstate=true;$("#addDriver").val("");$("#driver").parent("label").css("display","none");$(".heiChange1").css("height","4rem");$("#driver-add").css("display","none");$("#addDriver").css("display","block");$("#driverPhone").css("display","block");$("#driver-sel").css("display","inline-block")});$(document).on("click","#driver-sel",function(){driverstate=false;$("#driver").css("width","80%").parent("label").css("display","inline-block");$("#driver-add").css("display","block");$("#addDriver").css("display","none");$(".heiChange1").css("height","2rem");$("#driverPhone").css("display","none");$("#driver-sel").css("display","none")});