$("#change-add").css("display","none");$("#driver-add").css("display","none");var id=getQueryString("id");var userId=DES3.decrypt(localStorage.getItem("ud"));var ownerId=DES3.decrypt(localStorage.getItem("ownerId"));var isNewPerson=false;var driverstate=false;var locationText,locationNum,depotId;var data=Restful.get("bsinventoryrecord/"+id);var recordType=data.recordType;var depotRes=Restful.post("bsinventorydepot/getDepots",{userId:userId});if(depotRes){var html="";for(var i=0,len=depotRes.length;i<len;i++){html+='<li data-depot="'+depotRes[i].id+'">'+depotRes[i].name+"</li>"}$(".select").html("").append(html);$(".select li").each(function(b,c){if($(c).attr("data-depot")==data.depotId){$(".nav h2").html($(".select li").eq(b).text()+'<img src="accountData/img/u40.png"/>');$(".select li").eq(b).addClass("depotChange")}})}else{$(".select").html("").append('<li data-depot="0">默认库</li>');$(".select li").each(function(b,c){if($(c).attr("data-depot")==data.depotId){$(".nav h2").html($(".select li").eq(b).text()+'<img src="accountData/img/u40.png"/>');$(".select li").eq(b).addClass("depotChange")}})}var a={};a.userId=ownerId;if(recordType==1){a.staffType=1}else{if(recordType==2){a.staffType=2}}$("#deduction").on("focus",function(){if($("#deduction").val()==0||$("#deduction").val()==""){$("#deduction").val("")}});a.pageSize=1000;var select2Array=[],driverArray=[],licensePlate=["无"],phoneArray=[""],driverPhone=[""];var person=Restful.post("bsinventorystaff/list",a);if(person){if(person.success){var personArr=person.dataList;select2Array.push({id:0,text:"请选择",phone:""});$.each(personArr,function(b,c){select2Array.push({id:c.staffId,text:c.trueName,phone:c.phone});phoneArray.push(c.phone)})}else{select2Array.push({id:0,text:"无",phone:""})}}var driver=Restful.post("bsinventorystaff/list",{userId:ownerId,pageSize:1000});if(driver){if(driver.success){var driverArr=driver.dataList;driverArray.push({id:0,text:"请选择",phone:""});$.each(driverArr,function(b,c){driverArray.push({id:c.staffId,text:c.trueName,phone:c.phone});licensePlate.push(c.licensePlate);driverPhone.push(c.phone)})}else{driverArray.push({id:0,text:"无",phone:""})}}$("#salePerson").select2({data:select2Array,templateResult:formatState});$("#driver").select2({data:driverArray,templateResult:formatState});$("#driver").on("change",function(){var b=$("#driver").children("option:selected").index();$("#licensePlate").val(licensePlate[b])});function formatState(c){if(!c.id){return c.text}var b="";if(c.text!="请选择"){b=$('<span style="display: inline-block;height: 2rem;">姓名: '+c.text+"</br><span>手机号:"+c.phone+"</span></span>")}else{b=$('<span style="display: inline-block;">'+c.text+"</span>")}return b}if(recordType==1){$(".date").text("入库日期:");$(".type").text("送粮人:");$(".paymsg").text("二、付款信息")}else{if(recordType==2){$(".date").text("出库日期:");$(".type").text("买粮人:");$(".paymsg").text("二、收款信息")}}$("#salePerson").val(data.staffId).select2({data:select2Array,templateResult:formatState});$("#driver").val(data.driverId).select2({data:driverArray,templateResult:formatState});if(data.grainType==1){$(".xmlist").show();$(".meibian").hide();$(".addressSelete").citys({required:false,nodata:"disabled",code:data.location,onChange:function(b){console.log(b);locationText=b.province+b.city+b.area;locationNum=b.code;if($("#two").css("display")=="none"){$("select").attr("disabled",true)}}});$("#varietyType").val(data.varietyType);$("#packingType").val(data.packingType);$("#productionNiafe").val(data.productionNiafe);$("#smell").val(data.smell)}else{$(".xmlist").hide();$(".meibian").show()}$("#recordNumber").val(data.recordNumber);$("#date").val(data.date);$("#licensePlate").val(data.licensePlate);$("#rongzhong").val(data.bulkDensity);$("#buwanshanli").val(data.imperfectGrains);$("#water").val(data.moistureContent);$("#meibian").val(data.mildew);$("#impurity").val(data.impurity);$("#productQuality").val(data.productQuality);$("#grainType").val(data.grainType);$("#deduction").val(data.deduction?data.deduction:0);$("#quality").val(data.productQuality);$("#remark").val(data.remark);$("#grossWeightIn").val(recordType==1?data.grossWeightIn:data.grossWeightOut);$("#tareWeightIn").val(recordType==1?data.tareWeightIn:data.tareWeightOut);$("#netWeightIn").val(recordType==1?data.netWeightIn:data.netWeightOut);$("#unitPrice").val(data.unitPrice);$("#moneyIn").val(recordType==1?data.moneyIn:data.moneyOut);if(data.staffId){$("#salePerson").val(data.staffId).select2()}$("select").attr("disabled",true);$("input").attr("disabled",true);function Calculation(){var c=$("#grossWeightIn").val();var b=$("#tareWeightIn").val();var e=$("#unitPrice").val();var f=$("#deduction").val();var d=c-b-f;d=d.toFixed(2);var g=d*e*2;g=g.toFixed(2);$("#netWeightIn").val(d);$("#moneyIn").val(g)}$("#grossWeightIn").on("input",function(){Calculation()});$("#tareWeightIn").on("input",function(){Calculation()});$("#unitPrice").on("input",function(){Calculation()});$("#deduction").on("input",function(){Calculation()});$(document).on("change","#grainType",function(){var b=$("#grainType").val();if(b==1){$(".xmlist").show();$(".meibian").hide()}else{$(".xmlist").hide();$(".meibian").show()}});function checkForm(){var k=/^[1-9]\d*\.\d{0,2}|[1-9]\d*|0\.\d{0,2}|0$/;var l=/^[1-9]\d*\.\d{1}|[1-9]\d*|0\.\d{1}$/;var b=/^[1-9]\d*\.\d{0,3}|[1-9]\d*|0\.\d{0,3}$/;var h=$("#grainType").val();var d=$("#date").val();var g=$("#hour").val();var f=$("#minute").val();var c=g+":"+f;var e=$("#grossWeightIn").val();var n=$("#tareWeightIn").val();var j=$("#unitPrice").val();var m=e-n;if(m<0){alert("皮重不能大于毛重");return false}if(recordType==1){if($("#addPerson").val()!=""&&$("#phone").val()==""){alert("请填写送粮人手机号");return false}if($("#phone").val()!=""&&$("#addPerson").val()==""){alert("请填写送粮人姓名");return false}}else{if($("#addPerson").val()!=""&&$("#phone").val()==""){alert("请填写买粮人手机号");return false}if($("#phone").val()!=""&&$("#addPerson").val()==""){alert("请填买粮人写姓名");return false}}if($("#addDriver").val()!=""&&$("#driverPhone").val()==""){alert("请填写司机手机号");return false}if($("#driverPhone").val()!=""&&$("#addDriver").val()==""){alert("请填写司机姓名");return false}if($("#grossWeightIn").val()==""||$("#grossWeightIn").val()<=0){alert("请填写毛重后提交");return false}if($("#tareWeightIn").val()==""||$("#tareWeightIn").val()<0){alert("请填写皮重后提交");return false}if($("#unitPrice").val()==""){alert("请填写单价后提交");return false}if(!k.test($("#grossWeightIn").val())){alert("毛重最多八位整数俩位小数");return false}if(!k.test($("#tareWeightIn").val())){alert("皮重最多八位整数俩位小数");return false}if(!b.test($("#unitPrice").val())){alert("单价最多三位整数俩位小数");return false}if($("#water").val()!=""&&!l.test($("#water").val())){alert("水分最多俩位整数一位小数");return false}if($("#meibian").val()!=""&&!l.test($("#meibian").val())){alert("霉变最多俩位整数一位小数");return false}if($("#buwanshanli").val()!=""&&!l.test($("#buwanshanli").val())){alert("不完善粒最多俩位整数一位小数");return false}if($("#impurity").val()!=""&&!l.test($("#impurity").val())){alert("杂质最多俩位整数一位小数");return false}return true}$("#save").on("click",function(){var g=false;if(!checkForm()){return false}if($("#submit").hasClass("disable")){alert("不可重复提交");return}$("#submit").addClass("disable");var c=$("#date").val();var d={};var k=locationNum;var h=locationText;d.id=data.id;d.recordType=recordType;d.userId=ownerId;d.operateUserId=userId;d.depotId=depotId;d.recordNumber=data.recordNumber;d.date=c;d.licensePlate=$("#licensePlate").val();d.bulkDensity=$("#rongzhong").val();d.imperfectGrains=$("#buwanshanli").val();d.moistureContent=$("#water").val();d.impurity=$("#impurity").val();d.mildew=$("#meibian").val();d.productQuality=$("#quality").val();d.remark=$("#remark").val();d.grainType=$("#grainType").val();d.unitPrice=$("#unitPrice").val();d.deduction=$("#deduction").val();d.varietyType=$("#varietyType").val();d.packingType=$("#packingType").val();d.productionNiafe=$("#productionNiafe").val();d.smell=$("#smell").val();if(d.grainType==1){if(d.productQuality!=null&&d.productQuality!=""&&d.productQuality*1>0){if(d.bulkDensity==null||d.bulkDensity==""){alert("请填写容重！");$("#submit").removeClass("disable");return false}if(d.productQuality*1==1){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<790){alert("质量与容重不匹配，容重必须大于等于 790！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==2){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<770||d.bulkDensity*1>790){alert("质量与容重不匹配，容重必须大于等于 770，小于790！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==3){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<750||d.bulkDensity*1>770){alert("质量与容重不匹配，容重必须大于等于 750，小于770！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==4){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<730||d.bulkDensity*1>750){alert("质量与容重不匹配，容重必须大于等于 730，小于750！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==5){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<710||d.bulkDensity*1>730){alert("质量与容重不匹配，容重必须大于等于 710，小于730！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==6){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1>710){alert("质量与容重不匹配，容重必须小于 710！");$("#submit").removeClass("disable");return false}}}}}}}}}else{if(d.grainType!=3){if(d.productQuality!=null&&d.productQuality!=""&&d.productQuality*1>0){if(d.bulkDensity==null||d.bulkDensity==""){alert("请填写容重！");$("#submit").removeClass("disable");return false}if(d.productQuality*1==1){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<720){alert("质量与容重不匹配，容重必须大于等于 720！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==2){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<685||d.bulkDensity*1>720){alert("质量与容重不匹配，容重必须大于等于 685，小于720！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==3){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<650||d.bulkDensity*1>685){alert("质量与容重不匹配，容重必须大于等于 650，小于685！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==4){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<620||d.bulkDensity*1>650){alert("质量与容重不匹配，容重必须大于等于 620，小于650！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==5){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1<590||d.bulkDensity*1>620){alert("质量与容重不匹配，容重必须大于等于 590，小于620！");$("#submit").removeClass("disable");return false}}else{if(d.productQuality*1==6){if(d.bulkDensity!=null&&d.bulkDensity!=""&&d.bulkDensity*1>590){alert("质量与容重不匹配，容重必须小于 590！");$("#submit").removeClass("disable");return false}}}}}}}}}}if(recordType==1){d.grossWeightIn=$("#grossWeightIn").val();d.tareWeightIn=$("#tareWeightIn").val();d.netWeightIn=$("#netWeightIn").val();d.moneyIn=$("#moneyIn").val()}else{d.grossWeightOut=$("#grossWeightIn").val();d.tareWeightOut=$("#tareWeightIn").val();d.netWeightOut=$("#netWeightIn").val();d.moneyOut=$("#moneyIn").val()}if(k==undefined){k=""}if(h==undefined){h=""}d.location=k;d.locationDesc=h;if(driverstate){d.driverId=-100;d.driverName=$("#addDriver").val();d.driverPhone=$("#driverPhone").val();if(d.driverPhone!=null&&d.driverPhone!=""){var b={};b.userId=ownerId;b.staffType=3;b.phone=$("#driverPhone").val();g=Restful.post("bsinventorystaff/isExist",b)}}else{var f=$("#driver").val();if(f!=0){d.driverId=f;d.driverName=$("#driver").find("option:selected").text();var l=$("#driver").children("option:selected").index();d.driverPhone=driverPhone[l]}else{d.driverId="";d.driverName="";d.driverPhone=""}}if(!g){}else{alert("司机手机号已存在");$("#submit").removeClass("disable");return}if(isNewPerson){d.staffId=-100;d.staffName=$("#addPerson").val();d.staffPhone=$("#phone").val();if(d.staffPhone!=null&&d.staffPhone!=""){var b={};b.userId=ownerId;if(recordType==1){b.staffType=1}else{b.staffType=2}b.phone=$("#phone").val();g=Restful.post("bsinventorystaff/isExist",b)}}else{var e=$("#salePerson").val();if(e!=0){d.staffId=e;d.staffName=$("#salePerson option:selected").text();var l=$("#salePerson").children("option:selected").index();d.staffPhone=phoneArray[l]}else{d.staffId="";d.staffName="";d.staffPhone=""}}console.log(d);if(!g){var j=Restful.post("bsinventoryrecord/update",d);if(j.success){alert("成功");if(recordType==1){Restful.operateRecord(id,1,12);window.location.href="inStorage.html"}else{if(recordType==2){Restful.operateRecord(id,2,22);window.location.href="outStorage.html"}}}else{alert("提交失败");$("#submit").removeClass("disable")}}else{if(recordType==1){alert("送粮人手机号已存在")}else{alert("买粮人手机号已存在")}$("#submit").removeClass("disable")}});function getQueryString(b){var d=new RegExp("(^|&)"+b+"=([^&]*)(&|$)","i");var e=window.location.search.substr(1).match(d);var c="";if(e!=null){c=e[2]}d=null;e=null;return c==null||c==""||c=="undefined"?"":c}$(document).on("click","#change-add",function(){isNewPerson=true;$("#addPerson").val("");$("#salePerson").parent("label").css("display","none");$("#change-add").css("display","none");$(".heiChange").css("height","4rem");$("#addPerson").css("display","block");$("#phone").css("display","block");$("#change-sel").css("display","inline-block")});$(document).on("click","#change-sel",function(){isNewPerson=false;$("#salePerson").css("width","80%").parent("label").css("display","inline-block");$("#change-add").css("display","block");$("#addPerson").css("display","none");$(".heiChange").css("height","2rem");$("#phone").css("display","none");$("#change-sel").css("display","none")});$(document).on("click","#driver-add",function(){driverstate=true;$("#addDriver").val("");$("#driver").parent("label").css("display","none");$(".heiChange1").css("height","4rem");$("#driver-add").css("display","none");$("#addDriver").css("display","block");$("#driverPhone").css("display","block");$("#driver-sel").css("display","inline-block")});$(document).on("click","#driver-sel",function(){driverstate=false;$("#driver").css("width","80%").parent("label").css("display","inline-block");$("#driver-add").css("display","block");$("#addDriver").css("display","none");$(".heiChange1").css("height","2rem");$("#driverPhone").css("display","none");$("#driver-sel").css("display","none")});$(document).on("click","#editSub",function(){$(".can").removeClass("no-edit");$("input,select").removeAttr("disabled");$("#one").css("display","none");$("#two").css("display","block");$("#change-add").css("display","inline-block");$("#driver-add").css("display","inline-block");if(recordType==1){$(".title").text("入库单修改")}else{if(recordType==2){$(".title").text("出库单修改")}}$(".nav").click(function(){$(".select").slideToggle()});$(".select").on("click","li",function(){var b=$(this).text();depotId=$(this).attr("data-depot");$(this).addClass("depotChange").siblings().removeClass("depotChange");$(".nav h2").html(b+'<img src="accountData/img/u40.png"/>')})});$(document).on("click","#cencel",function(){if(recordType==1){location.href="inStorage.html"}else{if(recordType==2){location.href="outStorage.html"}}});$(document).on("click","#delete",function(){var c=confirm("是否删除本条数据?");if(c){var d={};d.recordId=id;var b=Restful.post("bsinventoryrecord/deleteRecordOrdre",d);if(b.success){alert("删除成功");if(recordType==1){Restful.operateRecord(id,1,13);location.href="inStorage.html"}else{if(recordType==2){Restful.operateRecord(id,2,23);location.href="outStorage.html"}}}}});